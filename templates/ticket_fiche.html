<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Ticket #{{ t.id }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<nav>
  <a href="/">Accueil</a>
  <a href="/tickets">Tickets</a>
  <a href="/materiels">Materiel</a>
  <a href="/clients">Clients</a>
  <a href="/planning">Planning</a>
  <span class="right">
    {% if current_user %}
      <a href="/me/password">Mon profil</a>
      {% if is_admin %} | <a href="/users">Gerer utilisateurs & groupes</a>{% endif %}
      | {{ current_user.full_name }} ({{ current_user.role }}) - <a href="/logout">Deconnexion</a>
    {% else %}
      <a href="/login">Connexion</a>
    {% endif %}
  </span>
</nav>

<main>
<div class="card">
  <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
    <div>
      <p class="muted" style="margin:0;">Ticket #{{ t.id }}</p>
      <h1 style="margin:6px 0 0;">{{ t.titre }}</h1>
    </div>
    <div style="display:flex; gap:8px; flex-wrap: wrap;">
      <a class="btn ghost pill sm" href="/tickets/{{ t.id }}/edit">Modifier</a>
      <a class="btn pill sm" href="/tickets">← Retour liste</a>
    </div>
  </div>

  <div class="ticket-meta-grid">
    <div class="ticket-meta-card">
      <span class="meta-label">Client</span>
      <div class="meta-value">
        <a href="/clients/{{ t.client.id }}">
          CLT-{{ "%04d"|format(t.client.id) }} → {{ t.client.nom }}
        </a>
      </div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">Sites / agences</span>
      <div class="meta-value">
        {% if t.sites %}
          <ul style="margin:0; padding-left:16px;">
            {% for s in t.sites %}
              <li>
                {{ s.nom }} {% if s.ville %}({{ s.ville }}){% endif %} → client :
                <a href="/clients/{{ s.client.id }}">{{ s.client.nom }}</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="muted">Aucun site associé</span>
        {% endif %}
      </div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">Type</span>
      <div class="meta-value">{{ t.type }}</div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">Priorité</span>
      <div class="meta-value">{{ t.priorite }}</div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">Assigné à</span>
      <div class="meta-value">
        {% if t.assigned_group %}
          Groupe {{ t.assigned_group.name }}
        {% elif t.assigned_user %}
          {{ t.assigned_user.full_name }}
        {% else %}
          Non assigné
        {% endif %}
      </div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">Catégorie matérielle</span>
      <div class="meta-value">{{ t.category.name if t.category else "Non définie" }}</div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">Type matériel</span>
      <div class="meta-value">{{ t.materiel_type.name if t.materiel_type else "Non défini" }}</div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">État</span>
      <div class="meta-value">{{ t.etat|etat_label }}</div>
    </div>
    <div class="ticket-meta-card">
      <span class="meta-label">Date d'ouverture</span>
      <div class="meta-value">{{ t.date_ouverture.strftime("%d/%m/%Y %H:%M") }}</div>
    </div>
    {% if t.date_cloture %}
    <div class="ticket-meta-card">
      <span class="meta-label">Date de clôture</span>
      <div class="meta-value">{{ t.date_cloture.strftime("%d/%m/%Y %H:%M") }}</div>
    </div>
    {% endif %}
  </div>

  <h2 class="mt-2" style="margin-bottom:6px;">Description</h2>
  {% if t.description %}
    <div class="description-box">{{ t.description }}</div>
  {% else %}
    <p class="muted">Aucune description.</p>
  {% endif %}

{% if current_user %}
  <h2>Modifier le statut</h2>
  {% if error_status %}<p style="color:red;">{{ error_status }}</p>{% endif %}
  {% if success_status %}<p style="color:lightgreen;">{{ success_status }}</p>{% endif %}
  <form method="post" style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; max-width:460px;">
    <input type="hidden" name="action" value="status">
    <div style="flex:1; min-width:220px;">
      <label for="etat" style="margin-top:0;">Statut</label>
      <select name="etat" id="etat">
        <option value="ouvert"   {% if t.etat == "ouvert" %}selected{% endif %}>Ouvert</option>
        <option value="en_cours" {% if t.etat == "en_cours" %}selected{% endif %}>En cours</option>
        <option value="resolu"   {% if t.etat == "resolu" %}selected{% endif %}>Résolu</option>
        <option value="cloture"  {% if t.etat == "cloture" %}selected{% endif %}>Clôturé</option>
      </select>
    </div>
    <button type="submit" class="btn pill sm" style="margin-top: 18px;">Mettre à jour</button>
  </form>

  {% if t.client.contract_type in ["credit_time", "credit_point"] %}
    <h3 style="margin-top:16px;">Décompter le contrat ({{ "temps" if t.client.contract_type=="credit_time" else "points" }})</h3>
    <form method="post" class="mt-1">
      <input type="hidden" name="action" value="log_contract">
      {% if t.client.contract_type == "credit_time" %}
        <div class="form-row">
          <div>
            <label>Durée (heures)</label>
            <input type="number" step="0.25" min="0" name="duration_hours" placeholder="Heures totales">
          </div>
          <div>
            <label>Début</label>
            <input type="time" name="start_time">
          </div>
          <div>
            <label>Fin</label>
            <input type="time" name="end_time">
          </div>
        </div>
        <small>Indiquez soit la durée, soit l'heure de début et de fin.</small>
      {% else %}
        <div class="form-row">
          <div>
            <label>Points utilisés</label>
            <input type="number" step="1" min="0" name="points_used" placeholder="Nombre de points">
          </div>
        </div>
      {% endif %}
      <div class="form-row">
        <div style="width:100%;">
          <label>Note</label>
          <input type="text" name="contract_note" placeholder="Note optionnelle">
        </div>
      </div>
      <button type="submit">Décompter</button>
    </form>
  {% endif %}

  <h2>Ajouter un commentaire</h2>
  <form method="post">
    <input type="hidden" name="action" value="comment">
    <textarea name="content" rows="3" required></textarea>
    <button type="submit">Ajouter</button>
  </form>
{% endif %}

<h2>Commentaires</h2>
{% if comments %}
  {% for c in comments %}
    <div class="comment">
      <div class="comment-header">
        <strong>{{ c.user.full_name }}</strong>
        <span>{{ c.created_at.strftime("%d/%m/%Y %H:%M") }}</span>
        {% if c.is_edited %}<span class="badge">édité</span>{% endif %}
        {% if is_admin and c.previous_content %}
          <details>
            <summary>Voir ce qui a été modifié</summary>
            <pre>{{ edit_diffs.get(c.id, "Aucune diff disponible.") }}</pre>
          </details>
        {% endif %}
      </div>
      <pre>{{ c.content }}</pre>

      {% set can_edit = (current_user and (current_user.id == c.user_id or is_admin)) %}
      {% if can_edit %}
        <details>
          <summary>Modifier ce commentaire</summary>
          <form method="post" style="margin-top:6px;">
            <input type="hidden" name="action" value="edit_comment">
            <input type="hidden" name="comment_id" value="{{ c.id }}">
            <textarea name="content" rows="4" style="width:100%;" required>{{ c.content }}</textarea>
            <button type="submit">Mettre à jour</button>
          </form>
        </details>
      {% endif %}
    </div>
  {% endfor %}
{% else %}
  <p>Aucun commentaire pour l'instant.</p>
{% endif %}

{% if contract_logs %}
  <h2>Décomptes contrat liés à ce ticket</h2>
  <ul>
    {% for log in contract_logs %}
      <li>{{ log.created_at.strftime("%d/%m/%Y %H:%M") }} - {{ "Temps (h)" if log.kind=="credit_time" else "Points" }} : {{ log.amount }}{% if log.note %} — {{ log.note }}{% endif %}</li>
    {% endfor %}
  </ul>
{% endif %}

{% if maintenance_contracts %}
  <h2>Contrats de maintenance du client</h2>
  <table>
    <tr>
      <th>No contrat</th>
      <th>Duree</th>
      <th>Type</th>
      <th>Date effet</th>
      <th>Date renouvellement</th>
      <th>Conditions</th>
      <th>Prix total</th>
      <th>Resilie</th>
      <th>Reconductible</th>
    </tr>
    {% for c in maintenance_contracts %}
      <tr>
        <td>{{ c.numero }}</td>
        <td>{{ c.duree or "-" }}</td>
        <td>{{ c.type_contrat or "-" }}</td>
        <td>{{ c.date_effet.strftime("%d/%m/%Y") if c.date_effet else "-" }}</td>
        <td>{{ c.date_renouvellement.strftime("%d/%m/%Y") if c.date_renouvellement else "-" }}</td>
        <td>{{ c.conditions or "-" }}</td>
        <td>{{ "%.2f"|format(c.prix_total) if c.prix_total is not none else "-" }}</td>
        <td>{{ "Oui" if c.resilie else "Non" }}</td>
        <td>{{ "Oui" if c.reconductible else "Non" }}</td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <h2>Contrats de maintenance du client</h2>
  <p class="muted">Aucun contrat de maintenance enregistré pour ce client.</p>
{% endif %}

<p><a href="/tickets">&larr; Retour à la liste</a></p>

</div>
</main>

</body>
</html>
