<!doctype html>
<html lang="fr" class="theme-{{ theme or 'dark' }}">
<head>
  <meta charset="utf-8">
  <title>Nouveau materiel</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<nav>
  <a href="/">Accueil</a>
  <a href="/tickets">Tickets</a>
  <a href="/materiels">Materiel</a>
  <a href="/clients">Clients</a>
  <a href="/planning">Planning</a>
  <span class="right">
    {% if current_user %}
      <a href="/me/password">Mon profil</a>
      {% if is_admin %} | <a href="/users">Gerer utilisateurs & groupes</a>{% endif %}
      | {{ current_user.full_name }} ({{ current_user.role }}) - <a href="/logout">Deconnexion</a>
    {% else %}
      <a href="/login">Connexion</a>
    {% endif %}
  </span>
</nav>

<main>
  <div class="card">
    <h1>Ajouter un materiel</h1>

    <form method="post">
      <label for="id_client">Client</label>
      <select name="id_client" id="id_client" required>
        {% for c in clients %}
          <option value="{{ c.id }}">{{ c.nom }}</option>
        {% endfor %}
      </select>

      <div class="form-row">
        <div>
          <label for="category_id">Categorie</label>
          <select name="category_id" id="category_id" required>
            <option value="">-- Choisir --</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="type_id">Type</label>
          <select name="type_id" id="type_id" required disabled>
            <option value="">-- Choisir --</option>
            {% for t in types %}
              <option value="{{ t.id }}" data-cat="{{ t.category_id }}">{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Modele</label>
          <input type="text" name="modele" required>
        </div>
        <div>
          <label>Numero de serie</label>
          <input type="text" name="numero_serie" required>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Date d'installation</label>
          <input type="date" name="date_installation">
        </div>
        <div>
          <label>Fin de garantie</label>
          <input type="date" name="garantie_fin">
        </div>
      </div>

      <label>Statut</label>
      <select name="statut">
        <option value="en service">En service</option>
        <option value="hs">HS</option>
        <option value="retire">Retire</option>
      </select>

      <button type="submit" class="mt-2">Enregistrer</button>
    </form>

    <p class="mt-2"><a href="/materiels">Retour</a></p>
  </div>
</main>

<script>
  const categorySelect = document.getElementById("category_id");
  const typeSelect = document.getElementById("type_id");

  function filterTypes() {
    const cat = categorySelect.value;
    const options = typeSelect.querySelectorAll("option");
    let hasVisible = false;
    let firstVisible = null;
    options.forEach(opt => {
      if (!opt.dataset.cat) return;
      if (!cat || opt.dataset.cat === cat) {
        opt.style.display = "block";
        if (!firstVisible) firstVisible = opt;
        hasVisible = true;
      } else {
        opt.style.display = "none";
        opt.selected = false;
      }
    });
    typeSelect.disabled = !cat || !hasVisible;
    if (cat && firstVisible) firstVisible.selected = true;
    if (!cat) typeSelect.value = "";
  }

  categorySelect.addEventListener("change", filterTypes);
  filterTypes();
</script>

</body>
</html>

