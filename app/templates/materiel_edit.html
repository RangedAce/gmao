<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Modifier le materiel</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<nav>
  <a href="/">Clients</a>
  <a href="/materiels">Materiels</a>
  <a href="/tickets">Tickets</a>
  <span class="right">
    {% if current_user %}
      Connecte : {{ current_user.full_name }} ({{ current_user.role }}) - <a href="/logout">Deconnexion</a>
    {% endif %}
  </span>
</nav>

<main>
  <div class="card">
    <h1>Modifier le materiel</h1>

    <form method="post">
      <label for="id_client">Client</label>
      <select name="id_client" id="id_client" required>
        {% for c in clients %}
          <option value="{{ c.id }}" {% if c.id == m.id_client %}selected{% endif %}>{{ c.nom }}</option>
        {% endfor %}
      </select>

      <div class="form-row">
        <div>
          <label for="category_id">Categorie</label>
          <select name="category_id" id="category_id" required>
            <option value="">-- Choisir --</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if cat.id == m.category_id %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="type_id">Type</label>
          <select name="type_id" id="type_id" required disabled>
            <option value="">-- Choisir --</option>
            {% for t in types %}
              <option value="{{ t.id }}" data-cat="{{ t.category_id }}" {% if t.id == m.type_id %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Modele</label>
          <input type="text" name="modele" value="{{ m.modele }}" required>
        </div>
        <div>
          <label>Numero de serie</label>
          <input type="text" name="numero_serie" value="{{ m.numero_serie }}" required>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Date d'installation</label>
          <input type="date" name="date_installation" value="{{ m.date_installation }}">
        </div>
        <div>
          <label>Fin de garantie</label>
          <input type="date" name="garantie_fin" value="{{ m.garantie_fin }}">
        </div>
      </div>

      <label>Statut</label>
      <select name="statut">
        <option value="en service" {% if m.statut == "en service" %}selected{% endif %}>En service</option>
        <option value="hs" {% if m.statut == "hs" %}selected{% endif %}>HS</option>
        <option value="retire" {% if m.statut == "retire" %}selected{% endif %}>Retire</option>
      </select>

      <button type="submit" class="mt-2">Enregistrer</button>
    </form>

    <p class="mt-2"><a href="/materiels/{{ m.id }}">Retour</a></p>
  </div>
</main>

<script>
  const categorySelect = document.getElementById("category_id");
  const typeSelect = document.getElementById("type_id");

  function filterTypes() {
    const cat = categorySelect.value;
    const options = typeSelect.querySelectorAll("option");
    let hasVisible = false;
    options.forEach(opt => {
      if (!opt.dataset.cat) return;
      if (!cat || opt.dataset.cat === cat) {
        opt.style.display = "block";
        hasVisible = true;
      } else {
        opt.style.display = "none";
        if (opt.selected) opt.selected = false;
      }
    });

    typeSelect.disabled = !cat || !hasVisible;
    if (!cat) {
      typeSelect.value = "";
    }
  }

  categorySelect.addEventListener("change", filterTypes);
  filterTypes();
</script>

</body>
</html>
