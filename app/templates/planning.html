{% extends "base.html" %}

{% block title %}Planning{% endblock %}

{% block head %}
  <!--
  FullCalendar resource views are premium plugins.
  You need a license to use them in production.
  See https://fullcalendar.io/pricing
  -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.css">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales/fr.global.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
  <h1>Planning</h1>
  <div id='calendar'></div>
</div>

<div id="assign-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Assigner un ticket</h2>
    <form id="assign-form">
      <input type="hidden" id="clicked-date" name="clicked-date">
      <input type="hidden" id="resource-id" name="resource-id">
      
      <div class="form-group">
        <label for="ticket-select">Ticket</label>
        <select id="ticket-select" name="ticket-id" required>
          <option value="">-- Choisir un ticket --</option>
          {% for ticket in unscheduled_tickets %}
            <option value="{{ ticket.id }}">#{{ ticket.id }} - {{ ticket.titre }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="form-group">
        <label for="resource-select">Ressource</label>
        <select id="resource-select" name="resource-id" required>
          <option value="">-- Choisir un technicien ou groupe --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="duration-input">Durée (minutes)</label>
        <input type="number" id="duration-input" name="duration" min="15" step="15" value="60" required>
      </div>
      
      <button type="submit">Assigner</button>
    </form>
  </div>
</div>

<div id="edit-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Modifier l'intervention</h2>
    <form id="edit-form">
      <div class="card" style="padding: 12px; margin-bottom: 12px; background: #0f1b2a;">
        <div id="summary-title" style="font-weight: 700; margin-bottom: 6px;">Ticket</div>
        <div id="summary-client" class="muted" style="margin-bottom: 4px;"></div>
        <div id="summary-responsable" class="muted" style="margin-bottom: 4px;"></div>
        <div id="summary-etat" class="muted" style="margin-bottom: 4px;"></div>
        <div id="summary-priorite" class="muted" style="margin-bottom: 4px;"></div>
        <div id="summary-description" class="muted" style="margin-top: 6px; line-height: 1.4;"></div>
        <div id="summary-comment" class="muted" style="margin-top: 10px; line-height: 1.4;"></div>
        <div class="form-actions" style="margin-top: 12px; gap: 8px;">
          <button type="button" id="open-ticket" class="btn">Ouvrir le ticket</button>
        </div>
      </div>
      <div class="form-group">
        <label for="edit-duration-input">Durée (minutes)</label>
        <input type="number" id="edit-duration-input" min="15" step="15" value="60" required>
      </div>
      <div class="form-actions">
        <button type="submit">Mettre à jour</button>
        <button type="button" id="delete-event" class="btn secondary">Supprimer</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var assignModal = document.getElementById('assign-modal');
    var editModal = document.getElementById('edit-modal');
    var closeButtons = document.querySelectorAll('.close-button');
    var assignForm = document.getElementById('assign-form');
    var editForm = document.getElementById('edit-form');
    var ticketSelect = document.getElementById('ticket-select');
    var clickedDateInput = document.getElementById('clicked-date');
    var resourceIdInput = document.getElementById('resource-id');
    var resourceSelect = document.getElementById('resource-select');
    var editDurationInput = document.getElementById('edit-duration-input');
    var deleteEventBtn = document.getElementById('delete-event');
    var openTicketBtn = document.getElementById('open-ticket');
    var summaryTitle = document.getElementById('summary-title');
    var summaryClient = document.getElementById('summary-client');
    var summaryResponsable = document.getElementById('summary-responsable');
    var summaryEtat = document.getElementById('summary-etat');
    var summaryPriorite = document.getElementById('summary-priorite');
    var summaryDescription = document.getElementById('summary-description');
    var summaryComment = document.getElementById('summary-comment');
    var activeEvent = null;

    // Construit une ISO locale sans décalage (évite de sauver à 07h quand on clique 08h)
    function toLocalISOString(dateObj) {
      const tzOffsetMs = dateObj.getTimezoneOffset() * 60000;
      const local = new Date(dateObj.getTime() - tzOffsetMs);
      return local.toISOString().slice(0, 19); // yyyy-MM-ddTHH:mm:ss
    }

    function removeTicketOption(ticketId) {
      Array.from(ticketSelect.options).forEach(function(opt) {
        if (opt.value === String(ticketId)) {
          opt.remove();
        }
      });
    }

    function addTicketOption(ticketId, label) {
      var exists = Array.from(ticketSelect.options).some(function(opt) {
        return opt.value === String(ticketId);
      });
      if (!exists) {
        var opt = document.createElement('option');
        opt.value = ticketId;
        opt.textContent = label;
        ticketSelect.appendChild(opt);
      }
    }

    var calendar = new FullCalendar.Calendar(calendarEl, {
      schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source', // Or your commercial license key
      locale: 'fr',
      initialView: 'resourceTimeGridWeek',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'resourceTimeGridWeek,resourceTimeGridDay,dayGridMonth'
      },
      timeZone: 'local',
      slotMinTime: '08:00:00',
      slotMaxTime: '17:30:00',
      allDaySlot: false,
      slotDuration: '00:30:00',
      slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      businessHours: [
        {
          daysOfWeek: [ 1, 2, 3, 4, 5 ], // Monday - Friday
          startTime: '08:00',
          endTime: '12:00',
        },
        {
          daysOfWeek: [ 1, 2, 3, 4, 5 ], // Monday - Friday
          startTime: '13:30',
          endTime: '17:30',
        }
      ],
      events: '/api/planning/events',
      resources: '/api/planning/resources',
      editable: true,
      eventDrop: function(info) {
        updateEvent(info.event);
      },
      eventResize: function(info) {
        updateEvent(info.event);
      },
      dateClick: function(info) {
        clickedDateInput.value = toLocalISOString(info.date);
        var resId = info.resource ? info.resource.id : '';
        resourceIdInput.value = resId;
        if (resId) {
          resourceSelect.value = resId;
        } else {
          resourceSelect.value = '';
        }
        assignModal.style.display = 'block';
      }
    });
    calendar.render();

    closeButtons.forEach(function(btn) {
      btn.onclick = function() {
        assignModal.style.display = 'none';
        editModal.style.display = 'none';
      };
    });

    window.onclick = function(event) {
      if (event.target == assignModal || event.target == editModal) {
        assignModal.style.display = 'none';
        editModal.style.display = 'none';
      }
    }

    assignForm.onsubmit = function(e) {
      e.preventDefault();
      var ticketId = document.getElementById('ticket-select').value;
      var duration = document.getElementById('duration-input').value;
      var start = clickedDateInput.value;
      var resourceId = resourceSelect.value;

      if (!ticketId) {
        alert('Veuillez choisir un ticket.');
        return;
      }
      if (!resourceId) {
        alert('Veuillez choisir une ressource.');
        return;
      }

      fetch('/api/planning/events/' + ticketId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: start,
          duration: duration,
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert("Erreur lors de l'assignation du ticket");
        } else {
          assignModal.style.display = 'none';
          removeTicketOption(ticketId);
          calendar.refetchEvents();
        }
      });
    }

    function loadResources() {
      fetch('/api/planning/resources')
        .then(resp => resp.json())
        .then(data => {
          resourceSelect.innerHTML = '<option value="">-- Choisir un technicien ou groupe --</option>';
          data.forEach(res => {
            var opt = document.createElement('option');
            opt.value = res.id;
            opt.textContent = res.title;
            resourceSelect.appendChild(opt);
          });
        })
        .catch(() => {
          resourceSelect.innerHTML = '<option value=\"\">Impossible de charger les ressources</option>';
        });
    }

    function updateEvent(event) {
      let resourceId = null;
      if (event.getResources().length > 0) {
        resourceId = event.getResources()[0].id;
      }

      fetch('/api/planning/events/' + event.id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: toLocalISOString(event.start),
          end: event.end ? toLocalISOString(event.end) : null,
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert('Error updating event');
          // In a real app, you'd want to revert the change on failure
          // info.revert(); 
        }
      });
    }

    function updateEventDuration(event, durationMinutes) {
      let resourceId = null;
      if (event.getResources().length > 0) {
        resourceId = event.getResources()[0].id;
      }

      fetch('/api/planning/events/' + event.id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: toLocalISOString(event.start),
          duration: durationMinutes,
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert('Erreur lors de la mise à jour');
        } else {
          editModal.style.display = 'none';
          calendar.refetchEvents();
        }
      });
    }

    function unscheduleEvent(event) {
      fetch('/api/planning/events/' + event.id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: null,
          end: null,
          resourceId: null
        })
      }).then(response => {
        if (!response.ok) {
          alert('Erreur lors de l\'annulation');
        } else {
          editModal.style.display = 'none';
          addTicketOption(event.id, event.title || ('#' + event.id));
          ticketSelect.value = event.id;
          calendar.refetchEvents();
        }
      });
    }

    function minutesDiff(start, end) {
      if (!start || !end) return null;
      return Math.round((end - start) / 60000);
    }

    function fillSummary(ev) {
      if (!ev) return;
      var props = ev.extendedProps || {};
      summaryTitle.textContent = ev.title || ('Ticket #' + ev.id);
      summaryClient.textContent = props.client ? 'Client : ' + props.client : '';
      var resp = props.user || props.group || 'Non assigné';
      summaryResponsable.textContent = 'Responsable : ' + resp;
      summaryEtat.textContent = props.etat ? 'État : ' + props.etat : '';
      summaryPriorite.textContent = props.priorite ? 'Priorité : ' + props.priorite : '';
      var desc = props.description || '';
      summaryDescription.textContent = desc ? ('Description : ' + desc) : '';
      var commentTxt = props.last_comment ? ('Dernier commentaire : ' + props.last_comment) : 'Dernier commentaire : aucun';
      var commentMeta = props.last_comment_user ? (' (' + props.last_comment_user + ')') : '';
      summaryComment.textContent = commentTxt + commentMeta;
      openTicketBtn.onclick = function() {
        if (props.url) {
          window.location.href = props.url;
        } else {
          window.location.href = '/tickets/' + ev.id;
        }
      };
    }

    calendar.setOption('eventClick', function(info) {
      activeEvent = info.event;
      var currentDuration = minutesDiff(activeEvent.start, activeEvent.end) || 60;
      editDurationInput.value = currentDuration;
      fillSummary(activeEvent);
      editModal.style.display = 'block';
    });

    editForm.onsubmit = function(e) {
      e.preventDefault();
      if (!activeEvent) return;
      var parsed = parseInt(editDurationInput.value, 10);
      if (!isNaN(parsed) && parsed > 0) {
        updateEventDuration(activeEvent, parsed);
      } else {
        alert('Entrée invalide.');
      }
    };

    deleteEventBtn.onclick = function() {
      if (!activeEvent) return;
      if (confirm("Confirmer l'annulation de cette intervention ?")) {
        unscheduleEvent(activeEvent);
      }
    };

    loadResources();
  });
</script>
{% endblock %}
