{% extends "base.html" %}

{% block title %}Planning{% endblock %}

{% block head %}
  <!--
  FullCalendar resource views are premium plugins.
  You need a license to use them in production.
  See https://fullcalendar.io/pricing
  -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.css">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales/fr.global.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
  <h1>Planning</h1>
  <div id='calendar'></div>
</div>

<div id="assign-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Assigner un ticket</h2>
    <form id="assign-form">
      <input type="hidden" id="clicked-date" name="clicked-date">
      <input type="hidden" id="resource-id" name="resource-id">
      
      <div class="form-group">
        <label for="ticket-select">Ticket</label>
        <select id="ticket-select" name="ticket-id" required>
          <option value="">-- Choisir un ticket --</option>
          {% for ticket in unscheduled_tickets %}
            <option value="{{ ticket.id }}">#{{ ticket.id }} - {{ ticket.titre }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="form-group">
        <label for="duration-input">Dur√©e (minutes)</label>
        <input type="number" id="duration-input" name="duration" min="15" step="15" value="60" required>
      </div>
      
      <button type="submit">Assigner</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var modal = document.getElementById('assign-modal');
    var closeButton = document.querySelector('.close-button');
    var assignForm = document.getElementById('assign-form');
    var clickedDateInput = document.getElementById('clicked-date');
    var resourceIdInput = document.getElementById('resource-id');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source', // Or your commercial license key
      locale: 'fr',
      initialView: 'resourceTimeGridWeek',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'resourceTimeGridWeek,resourceTimeGridDay,dayGridMonth'
      },
      timeZone: 'local',
      slotMinTime: '08:00:00',
      slotMaxTime: '18:00:00',
      allDaySlot: false,
      slotDuration: '00:30:00',
      slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      businessHours: [
        {
          daysOfWeek: [ 1, 2, 3, 4, 5 ], // Monday - Friday
          startTime: '08:00',
          endTime: '12:00',
        },
        {
          daysOfWeek: [ 1, 2, 3, 4, 5 ], // Monday - Friday
          startTime: '13:30',
          endTime: '17:30',
        }
      ],
      events: '/api/planning/events',
      resources: '/api/planning/resources',
      editable: true,
      eventDrop: function(info) {
        updateEvent(info.event);
      },
      eventResize: function(info) {
        updateEvent(info.event);
      },
      dateClick: function(info) {
        clickedDateInput.value = info.date.toISOString();
        resourceIdInput.value = info.resource ? info.resource.id : '';
        modal.style.display = 'block';
      }
    });
    calendar.render();

    closeButton.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    assignForm.onsubmit = function(e) {
      e.preventDefault();
      var ticketId = document.getElementById('ticket-select').value;
      var duration = document.getElementById('duration-input').value;
      var start = clickedDateInput.value;
      var resourceId = resourceIdInput.value;

      if (!ticketId) {
        alert('Veuillez choisir un ticket.');
        return;
      }

      fetch('/api/planning/events/' + ticketId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: start,
          duration: duration,
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert("Erreur lors de l'assignation du ticket");
        } else {
          modal.style.display = 'none';
          calendar.refetchEvents();
        }
      });
    }

    function updateEvent(event) {
      let resourceId = null;
      if (event.getResources().length > 0) {
        resourceId = event.getResources()[0].id;
      }

      fetch('/api/planning/events/' + event.id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: event.start.toISOString(),
          end: event.end.toISOString(),
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert('Error updating event');
          // In a real app, you'd want to revert the change on failure
          // info.revert(); 
        }
      });
    }
  });
</script>
{% endblock %}
