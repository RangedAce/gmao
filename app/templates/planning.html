{% extends "base.html" %}

{% block title %}Planning{% endblock %}

{% block head %}
  <!--
  FullCalendar resource views are premium plugins.
  You need a license to use them in production.
  See https://fullcalendar.io/pricing
  -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.css">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales/fr.global.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
  <h1>Planning</h1>
  <div id='calendar'></div>
</div>

<div id="assign-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Assigner un ticket</h2>
    <form id="assign-form">
      <input type="hidden" id="clicked-date" name="clicked-date">
      <input type="hidden" id="resource-id" name="resource-id">
      
      <div class="form-group">
        <label for="ticket-select">Ticket</label>
        <select id="ticket-select" name="ticket-id" required>
          <option value="">-- Choisir un ticket --</option>
          {% for ticket in unscheduled_tickets %}
            <option value="{{ ticket.id }}">#{{ ticket.id }} - {{ ticket.titre }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="form-group">
        <label for="resource-select">Ressource</label>
        <select id="resource-select" name="resource-id" required>
          <option value="">-- Choisir un technicien ou groupe --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="duration-input">Durée (minutes)</label>
        <input type="number" id="duration-input" name="duration" min="15" step="15" value="60" required>
      </div>
      
      <button type="submit">Assigner</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var modal = document.getElementById('assign-modal');
    var closeButton = document.querySelector('.close-button');
    var assignForm = document.getElementById('assign-form');
    var clickedDateInput = document.getElementById('clicked-date');
    var resourceIdInput = document.getElementById('resource-id');
    var resourceSelect = document.getElementById('resource-select');

    // Construit une ISO locale sans décalage (évite de sauver à 07h quand on clique 08h)
    function toLocalISOString(dateObj) {
      const tzOffsetMs = dateObj.getTimezoneOffset() * 60000;
      const local = new Date(dateObj.getTime() - tzOffsetMs);
      return local.toISOString().slice(0, 19); // yyyy-MM-ddTHH:mm:ss
    }

    var calendar = new FullCalendar.Calendar(calendarEl, {
      schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source', // Or your commercial license key
      locale: 'fr',
      initialView: 'resourceTimeGridWeek',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'resourceTimeGridWeek,resourceTimeGridDay,dayGridMonth'
      },
      timeZone: 'local',
      slotMinTime: '08:00:00',
      slotMaxTime: '18:00:00',
      allDaySlot: false,
      slotDuration: '00:30:00',
      slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      businessHours: [
        {
          daysOfWeek: [ 1, 2, 3, 4, 5 ], // Monday - Friday
          startTime: '08:00',
          endTime: '12:00',
        },
        {
          daysOfWeek: [ 1, 2, 3, 4, 5 ], // Monday - Friday
          startTime: '13:30',
          endTime: '17:30',
        }
      ],
      events: '/api/planning/events',
      resources: '/api/planning/resources',
      editable: true,
      eventDrop: function(info) {
        updateEvent(info.event);
      },
      eventResize: function(info) {
        updateEvent(info.event);
      },
      dateClick: function(info) {
        clickedDateInput.value = toLocalISOString(info.date);
        var resId = info.resource ? info.resource.id : '';
        resourceIdInput.value = resId;
        if (resId) {
          resourceSelect.value = resId;
        } else {
          resourceSelect.value = '';
        }
        modal.style.display = 'block';
      }
    });
    calendar.render();

    closeButton.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    assignForm.onsubmit = function(e) {
      e.preventDefault();
      var ticketId = document.getElementById('ticket-select').value;
      var duration = document.getElementById('duration-input').value;
      var start = clickedDateInput.value;
      var resourceId = resourceSelect.value;

      if (!ticketId) {
        alert('Veuillez choisir un ticket.');
        return;
      }
      if (!resourceId) {
        alert('Veuillez choisir une ressource.');
        return;
      }

      fetch('/api/planning/events/' + ticketId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: start,
          duration: duration,
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert("Erreur lors de l'assignation du ticket");
        } else {
          modal.style.display = 'none';
          calendar.refetchEvents();
        }
      });
    }

    function loadResources() {
      fetch('/api/planning/resources')
        .then(resp => resp.json())
        .then(data => {
          resourceSelect.innerHTML = '<option value="">-- Choisir un technicien ou groupe --</option>';
          data.forEach(res => {
            var opt = document.createElement('option');
            opt.value = res.id;
            opt.textContent = res.title;
            resourceSelect.appendChild(opt);
          });
        })
        .catch(() => {
          resourceSelect.innerHTML = '<option value=\"\">Impossible de charger les ressources</option>';
        });
    }

    function updateEvent(event) {
      let resourceId = null;
      if (event.getResources().length > 0) {
        resourceId = event.getResources()[0].id;
      }

      fetch('/api/planning/events/' + event.id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: toLocalISOString(event.start),
          end: event.end ? toLocalISOString(event.end) : null,
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert('Error updating event');
          // In a real app, you'd want to revert the change on failure
          // info.revert(); 
        }
      });
    }

    function updateEventDuration(event, durationMinutes) {
      let resourceId = null;
      if (event.getResources().length > 0) {
        resourceId = event.getResources()[0].id;
      }

      fetch('/api/planning/events/' + event.id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: toLocalISOString(event.start),
          duration: durationMinutes,
          resourceId: resourceId
        })
      }).then(response => {
        if (!response.ok) {
          alert('Erreur lors de la mise à jour');
        } else {
          calendar.refetchEvents();
        }
      });
    }

    function unscheduleEvent(event) {
      fetch('/api/planning/events/' + event.id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          start: null,
          end: null,
          resourceId: null
        })
      }).then(response => {
        if (!response.ok) {
          alert('Erreur lors de l\'annulation');
        } else {
          calendar.refetchEvents();
        }
      });
    }

    function minutesDiff(start, end) {
      if (!start || !end) return null;
      return Math.round((end - start) / 60000);
    }

    calendar.setOption('eventClick', function(info) {
      var event = info.event;
      var currentDuration = minutesDiff(event.start, event.end) || 60;
      var action = prompt(
        "Modifier ou annuler l'intervention :\n- Tapez une nouvelle durée (minutes)\n- Tapez 'supprimer' pour annuler\nDurée actuelle : " + currentDuration + " min",
        currentDuration
      );
      if (action === null) return;
      if (action.toLowerCase() === 'supprimer') {
        if (confirm("Confirmer l'annulation de cette intervention ?")) {
          unscheduleEvent(event);
        }
        return;
      }
      var parsed = parseInt(action, 10);
      if (!isNaN(parsed) && parsed > 0) {
        updateEventDuration(event, parsed);
      } else {
        alert('Entrée invalide.');
      }
    });

    loadResources();
  });
</script>
{% endblock %}
