<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Client {{ client.nom }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<nav>
  <a href="/">Accueil</a>
  <a href="/tickets">Tickets</a>
  <a href="/materiels">Materiel</a>
  <a href="/clients">Clients</a>
  <span class="right">
    {% if current_user %}
      <a href="/me/password">Mon profil</a>
      {% if is_admin %} | <a href="/users">Gerer utilisateurs & groupes</a>{% endif %}
      | {{ current_user.full_name }} ({{ current_user.role }}) - <a href="/logout">Deconnexion</a>
    {% else %}
      <a href="/login">Connexion</a>
    {% endif %}
  </span>
</nav>

<main>
  <div class="card">
    <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px;">
      <h1>Client CLT-{{ "%04d"|format(client.id) }} - {{ client.nom }}</h1>
      <a class="btn" href="/clients/{{ client.id }}/edit">Modifier</a>
    </div>
    <p class="muted">Visuel refonte palette mauve / steel-blue.</p>
  </div>

  <div class="grid-2">
    <div class="card">
      <h2>Contrat</h2>
      <p>
        Type :
        {% if client.contract_type == "credit_time" %}
          Credit temps
        {% elif client.contract_type == "credit_point" %}
          Credit points
        {% else %}
          Pas de contrat
        {% endif %}
      </p>
      <p>Solde : {{ client.contract_balance if client.contract_balance is not none else "N/A" }}</p>
      <p class="mt-1"><a class="btn secondary" href="#interventions">Voir les interventions</a></p>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Contrats de maintenance</h2>
        <a class="btn" href="{{ url_for('maintenance_contract_new', client_id=client.id) }}">+ Ajouter</a>
      </div>
      {% if maintenance_contracts %}
        <table>
          <tr>
            <th>No contrat</th>
            <th>Duree</th>
            <th>Type</th>
            <th>Date effet</th>
            <th>Date renouvellement</th>
            <th>Conditions</th>
            <th>Prix total</th>
            <th>Resilie</th>
            <th>Reconductible</th>
            <th>Actions</th>
          </tr>
          {% for c in maintenance_contracts %}
            <tr>
              <td>{{ c.numero }}</td>
              <td>{{ c.duree or "-" }}</td>
              <td>{{ c.type_contrat or "-" }}</td>
              <td>{{ c.date_effet.strftime("%d/%m/%Y") if c.date_effet else "-" }}</td>
              <td>{{ c.date_renouvellement.strftime("%d/%m/%Y") if c.date_renouvellement else "-" }}</td>
              <td>{{ c.conditions or "-" }}</td>
              <td>{{ "%.2f"|format(c.prix_total) if c.prix_total is not none else "-" }}</td>
              <td>{{ "Oui" if c.resilie else "Non" }}</td>
              <td>{{ "Oui" if c.reconductible else "Non" }}</td>
              <td>
                <a class="btn small" href="{{ url_for('maintenance_contract_edit', contract_id=c.id) }}">Modifier</a>
                <form method="post" action="{{ url_for('maintenance_contract_delete', contract_id=c.id) }}" style="display:inline;" onsubmit="return confirm('Supprimer ce contrat ?');">
                  <button type="submit" class="btn danger small">Supprimer</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </table>
      {% else %}
        <p class="muted">Aucun contrat de maintenance enregistre.</p>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Sites / agences</h2>
      <a class="btn" href="{{ url_for('nouveau_site', client_id=client.id) }}">+ Ajouter</a>
    </div>
    {% if client.sites %}
      <table>
        <tr>
          <th>Nom</th>
          <th>Adresse</th>
          <th>Ville</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
        {% for s in client.sites %}
          <tr>
            <td>{{ s.nom }}</td>
            <td>{{ s.adresse }}</td>
            <td>{{ s.ville }}</td>
            <td>{{ s.notes }}</td>
            <td>
              <a class="btn small" href="{{ url_for('edit_site', site_id=s.id) }}">Modifier</a>
              <form method="post" action="{{ url_for('delete_site', site_id=s.id) }}" style="display:inline;" onsubmit="return confirm('Supprimer ce site ?');">
                <button type="submit" class="btn danger small">Supprimer</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p class="muted">Aucun site enregistre pour ce client.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Materiels</h2>
    {% if materiels %}
      <ul>
        {% for m in materiels %}
          <li><a href="/materiels/{{ m.id }}">{{ m.type }} {{ m.modele }} ({{ m.numero_serie }})</a></li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Aucun materiel pour ce client.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Tickets</h2>
    {% if tickets %}
      <ul>
        {% for t in tickets %}
          <li>
            <a href="/tickets/{{ t.id }}">[#{{ t.id }}] {{ t.titre }}</a>
            - {{ t.etat }} - priorite {{ t.priorite }}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Aucun ticket pour ce client.</p>
    {% endif %}
  </div>

  <div class="card" id="interventions">
    <h2>Historique des interventions (decomptes contrat)</h2>
    {% if contract_logs %}
      <table>
        <tr>
          <th>Date</th>
          <th>Ticket</th>
          <th>Type</th>
          <th>Montant</th>
          <th>Resume</th>
        </tr>
        {% for log in contract_logs %}
          <tr>
            <td>{{ log.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
            <td><a href="/tickets/{{ log.ticket_id }}">#{{ log.ticket_id }}</a></td>
            <td>{{ "Temps (h)" if log.kind == "credit_time" else "Points" }}</td>
            <td>{{ log.amount }}</td>
            <td>{{ log.note }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p class="muted">Aucun decomptes enregistres.</p>
    {% endif %}
  </div>

  <p class="muted"><a href="/">Retour a la liste des clients</a></p>
</main>

</body>
</html>
