<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Nouveau ticket</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    nav a { margin-right: 10px; }
    form { max-width: 600px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 15px; padding: 8px 12px; }
    .error { color: red; margin-top: 10px; }
  </style>
</head>
<body>

<nav>
  <a href="/">Clients</a>
  <a href="/materiels">Mat&eacute;riels</a>
  <a href="/tickets">Tickets</a>
</nav>

<h1>Nouveau ticket</h1>

{% if error %}
  <p class="error">{{ error }}</p>
{% endif %}

<form method="post">
  <label for="id_client">Client</label>
  <select name="id_client" id="id_client" required>
    <option value="" disabled selected>-- Choisir un client --</option>
    {% for c in clients %}
      <option value="{{ c.id }}">{{ c.nom }}</option>
    {% endfor %}
  </select>

<label>Mat&eacute;riels concern&eacute;s (optionnel, plusieurs possibles)</label>
<div id="materiels-container" style="border:1px solid #ccc; padding:8px; max-height:200px; overflow:auto;">
  <p id="materiels-placeholder" style="margin:0; color:#555;">S&eacute;lectionnez un client pour afficher les mat&eacute;riels.</p>
</div>

<label>Sites / agences concern&eacute;s (optionnel)</label>
<div id="sites-container" style="border:1px solid #ccc; padding:8px; max-height:200px; overflow:auto;">
  <p id="sites-placeholder" style="margin:0; color:#555;">S&eacute;lectionnez un client pour afficher les sites.</p>
</div>

<script>
  const clientSelect = document.getElementById("id_client");
  const materielsContainer = document.getElementById("materiels-container");
  const sitesContainer = document.getElementById("sites-container");

  function setPlaceholder(container, text) {
    container.innerHTML = `<p style="margin:0; color:#555;">${text}</p>`;
  }

  function renderCheckboxList(container, items, inputName) {
    container.innerHTML = "";
    if (!items.length) {
      setPlaceholder(container, "Aucun r&eacute;sultat pour ce client.");
      return;
    }

    items.forEach(item => {
      const label = document.createElement("label");
      label.style.display = "block";
      label.style.marginBottom = "4px";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.name = inputName;
      input.value = item.id;

      label.appendChild(input);
      label.append(` ${item.label}`);
      container.appendChild(label);
    });
  }

  async function loadDataForClient(clientId) {
    if (!clientId) {
      setPlaceholder(materielsContainer, "S&eacute;lectionnez un client pour afficher les mat&eacute;riels.");
      setPlaceholder(sitesContainer, "S&eacute;lectionnez un client pour afficher les sites.");
      return;
    }

    setPlaceholder(materielsContainer, "Chargement des mat&eacute;riels...");
    setPlaceholder(sitesContainer, "Chargement des sites...");

    try {
      const response = await fetch(`/api/client/${clientId}/data`);
      if (!response.ok) throw new Error("fetch");
      const data = await response.json();

      renderCheckboxList(materielsContainer, data.materiels || [], "materiels_ids");
      renderCheckboxList(sitesContainer, data.sites || [], "sites_ids");
    } catch (err) {
      setPlaceholder(materielsContainer, "Impossible de charger les mat&eacute;riels.");
      setPlaceholder(sitesContainer, "Impossible de charger les sites.");
    }
  }

  clientSelect.addEventListener("change", (e) => {
    loadDataForClient(e.target.value);
  });

  // Init au chargement
  loadDataForClient(clientSelect.value);
</script>

  <label for="type">Type</label>
  <select name="type" id="type" required>
    <option value="incident">Incident</option>
    <option value="demande">Demande</option>
  </select>

  <label for="priorite">Priorit&eacute;</label>
  <select name="priorite" id="priorite" required>
    <option value="basse">Basse</option>
    <option value="normale" selected>Normale</option>
    <option value="haute">Haute</option>
    <option value="critique">Critique</option>
  </select>

  <label for="titre">Titre</label>
  <input type="text" name="titre" id="titre" required>

  <label for="description">Description</label>
  <textarea name="description" id="description" rows="5"></textarea>

  <button type="submit">Cr&eacute;er le ticket</button>
</form>

<p><a href="/tickets">&larr; Retour &agrave; la liste</a></p>

</body>
</html>
