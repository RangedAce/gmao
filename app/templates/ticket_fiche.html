<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Ticket #{{ t.id }}</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    nav a { margin-right: 10px; }
    p span { font-weight: bold; }
    pre { background: #f5f5f5; padding: 10px; white-space: pre-wrap; }
    .comment {
      border-top: 1px solid #ddd;
      padding-top: 8px;
      margin-top: 8px;
    }
    .comment-header {
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>

<nav>
  <a href="/">Clients</a>
  <a href="/materiels">Matériels</a>
  <a href="/tickets">Tickets</a>

  <span style="float:right;">
    {% if current_user %}
      Connecté : {{ current_user.full_name }} ({{ current_user.role }})
      — <a href="/logout">Déconnexion</a>
    {% else %}
      <a href="/login">Connexion</a>
    {% endif %}
  </span>
</nav>
<hr>

<h1>Ticket #{{ t.id }} — {{ t.titre }}</h1>

<p><span>Client :</span>
  <a href="/clients/{{ t.client.id }}">
    CLT-{{ "%04d"|format(t.client.id) }} – {{ t.client.nom }}
  </a>
</p>


<p><span>Sites / agences :</span>
  {% if t.sites %}
    <ul>
      {% for s in t.sites %}
        <li>
          {{ s.nom }}
          {% if s.ville %}({{ s.ville }}){% endif %}
          – client :
          <a href="/clients/{{ s.client.id }}">
            {{ s.client.nom }}
          </a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    Aucun site associé
  {% endif %}
</p>

<p>
  <a href="/tickets/{{ t.id }}/edit">✏️ Modifier le ticket</a>
</p>
<p><span>Type :</span> {{ t.type }}</p>
<p><span>Priorité :</span> {{ t.priorite }}</p>
<p><span>État :</span> {{ t.etat }}</p>

<p><span>Date d’ouverture :</span> {{ t.date_ouverture.strftime("%d/%m/%Y %H:%M") }}</p>
{% if t.date_cloture %}
  <p><span>Date de clôture :</span> {{ t.date_cloture.strftime("%d/%m/%Y %H:%M") }}</p>
{% endif %}

<p><span>Description :</span></p>
{% if t.description %}
  <pre>{{ t.description }}</pre>
{% else %}
  <p>Aucune description.</p>
{% endif %}

{% if current_user %}
  <h2>Modifier le statut</h2>
  <form method="post">
    <input type="hidden" name="action" value="status">
    <select name="etat">
      <option value="ouvert"   {% if t.etat == "ouvert" %}selected{% endif %}>Ouvert</option>
      <option value="en_cours" {% if t.etat == "en_cours" %}selected{% endif %}>En cours</option>
      <option value="resolu"   {% if t.etat == "resolu" %}selected{% endif %}>Résolu</option>
      <option value="cloture"  {% if t.etat == "cloture" %}selected{% endif %}>Clôturé</option>
    </select>
    <button type="submit">Mettre à jour</button>
  </form>

  <h2>Ajouter un commentaire</h2>
  <form method="post">
    <input type="hidden" name="action" value="comment">
    <textarea name="content" rows="4" style="width:100%;" required></textarea>
    <button type="submit">Envoyer</button>
  </form>
{% else %}
  <p><em>Connecte-toi pour modifier le statut ou ajouter un commentaire.</em></p>
{% endif %}

<h2>Commentaires</h2>
{% if comments %}
  {% for c in comments %}
    <div class="comment">
      <div class="comment-header">
        {{ c.user.full_name }} – {{ c.user.role|capitalize }}
        ({{ c.created_at.strftime("%d/%m/%Y %H:%M") }})
      </div>
      <pre>{{ c.content }}</pre>
    </div>
  {% endfor %}
{% else %}
  <p>Aucun commentaire pour l’instant.</p>
{% endif %}

<p>
  <a href="/tickets">← Retour à la liste</a>
</p>

</body>
</html>
