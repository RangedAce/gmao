<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Ticket #{{ t.id }}</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    nav a { margin-right: 10px; }
    p span { font-weight: bold; }
    pre { background: #f5f5f5; padding: 10px; white-space: pre-wrap; }
    .comment { border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px; }
    .comment-header { font-size: 0.9em; color: #555; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .badge { background: #eef; color: #335; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
    details summary { cursor: pointer; }
  </style>
</head>
<body>

<nav>
  <a href="/">Clients</a>
  <a href="/materiels">Matériels</a>
  <a href="/tickets">Tickets</a>
  <span style="float:right;">
    {% if current_user %}
      Connecté : {{ current_user.full_name }} ({{ current_user.role }})
      &rarr; <a href="/logout">Déconnexion</a>
    {% else %}
      <a href="/login">Connexion</a>
    {% endif %}
  </span>
</nav>
<hr>

<h1>Ticket #{{ t.id }} &rarr; {{ t.titre }}</h1>

<p><span>Client :</span>
  <a href="/clients/{{ t.client.id }}">
    CLT-{{ "%04d"|format(t.client.id) }} &rarr; {{ t.client.nom }}
  </a>
</p>

<p><span>Sites / agences :</span>
  {% if t.sites %}
    <ul>
      {% for s in t.sites %}
        <li>
          {{ s.nom }} {% if s.ville %}({{ s.ville }}){% endif %} &rarr; client :
          <a href="/clients/{{ s.client.id }}">{{ s.client.nom }}</a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    Aucun site associé
  {% endif %}
</p>

<p><a href="/tickets/{{ t.id }}/edit">Modifier le ticket</a></p>
<p><span>Type :</span> {{ t.type }}</p>
<p><span>Priorité :</span> {{ t.priorite }}</p>
<p><span>Catégorie matérielle :</span> {{ t.category.name if t.category else "Non définie" }}</p>
<p><span>Type matériel :</span> {{ t.materiel_type.name if t.materiel_type else "Non défini" }}</p>
<p><span>État :</span> {{ t.etat }}</p>
<p><span>Date d'ouverture :</span> {{ t.date_ouverture.strftime("%d/%m/%Y %H:%M") }}</p>
{% if t.date_cloture %}
  <p><span>Date de clôture :</span> {{ t.date_cloture.strftime("%d/%m/%Y %H:%M") }}</p>
{% endif %}

<p><span>Description :</span></p>
{% if t.description %}
  <pre>{{ t.description }}</pre>
{% else %}
  <p>Aucune description.</p>
{% endif %}

{% if current_user %}
  <h2>Modifier le statut</h2>
  {% if error_status %}<p style="color:red;">{{ error_status }}</p>{% endif %}
  <form method="post">
    <input type="hidden" name="action" value="status">
    <select name="etat">
      <option value="ouvert"   {% if t.etat == "ouvert" %}selected{% endif %}>Ouvert</option>
      <option value="en_cours" {% if t.etat == "en_cours" %}selected{% endif %}>En cours</option>
      <option value="resolu"   {% if t.etat == "resolu" %}selected{% endif %}>Résolu</option>
      <option value="cloture"  {% if t.etat == "cloture" %}selected{% endif %}>Clôturé</option>
    </select>

    {% if t.client.contract_type == "credit_time" %}
      <p>Décompte crédit temps :</p>
      <label>Durée (heures)
        <input type="number" step="0.1" min="0" name="duration_hours">
      </label>
      <p style="margin:4px 0;">ou</p>
      <label>Heure début <input type="time" name="start_time"></label>
      <label>Heure fin <input type="time" name="end_time"></label>
      <label>Commentaire (résumé intervention)
        <input type="text" name="contract_note">
      </label>
    {% elif t.client.contract_type == "credit_point" %}
      <p>Décompte crédit points :</p>
      <label>Nombre d'interventions/connexions
        <input type="number" step="1" min="1" name="points_used">
      </label>
      <label>Commentaire (résumé intervention)
        <input type="text" name="contract_note">
      </label>
    {% endif %}

    <button type="submit">Mettre à jour</button>
  </form>

  <h2>Ajouter un commentaire</h2>
  <form method="post">
    <input type="hidden" name="action" value="comment">
    <textarea name="content" rows="4" style="width:100%;" required></textarea>
    <button type="submit">Envoyer</button>
  </form>
{% else %}
  <p><em>Connectez-vous pour modifier le statut ou ajouter un commentaire.</em></p>
{% endif %}

<h2>Commentaires</h2>
{% if comments %}
  {% for c in comments %}
    {% set can_edit = current_user and (current_user.id == c.user_id or current_user.role == 'admin') %}
    <div class="comment">
      <div class="comment-header">
        <span>{{ c.user.full_name }} ({{ c.user.role }})</span>
        <span>{{ c.created_at.strftime("%d/%m/%Y %H:%M") }}</span>
        {% if c.is_edited %}
          <span class="badge">modifié</span>
          {% if c.updated_at %}
            <span>({{ c.updated_at.strftime("%d/%m/%Y %H:%M") }})</span>
          {% endif %}
          {% if is_admin %}
            <details>
              <summary>Voir ce qui a été modifié</summary>
              <pre>{{ edit_diffs.get(c.id, "Aucune diff disponible.") }}</pre>
            </details>
          {% endif %}
        {% endif %}
      </div>
      <pre>{{ c.content }}</pre>

      {% if can_edit %}
        <details>
          <summary>Modifier ce commentaire</summary>
          <form method="post" style="margin-top:6px;">
            <input type="hidden" name="action" value="edit_comment">
            <input type="hidden" name="comment_id" value="{{ c.id }}">
            <textarea name="content" rows="4" style="width:100%;" required>{{ c.content }}</textarea>
            <button type="submit">Mettre à jour</button>
          </form>
        </details>
      {% endif %}
    </div>
  {% endfor %}
{% else %}
  <p>Aucun commentaire pour l'instant.</p>
{% endif %}

<p><a href="/tickets">&larr; Retour à la liste</a></p>

{% if contract_logs %}
  <h2>Décomptes contrat liés à ce ticket</h2>
  <ul>
    {% for log in contract_logs %}
      <li>{{ log.created_at.strftime("%d/%m/%Y %H:%M") }} - {{ "Temps (h)" if log.kind=="credit_time" else "Points" }} : {{ log.amount }}{% if log.note %} — {{ log.note }}{% endif %}</li>
    {% endfor %}
  </ul>
{% endif %}

</body>
</html>
