<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Tickets</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<nav>
  <a href="/">Accueil</a>
  <a href="/tickets">Tickets</a>
  <a href="/materiels">Materiel</a>
  <a href="/clients">Clients</a>
  <span class="right">
    {% if current_user %}
      <a href="/me/password">Mon profil</a>
      {% if is_admin %} | <a href="/users">Gerer utilisateurs & groupes</a>{% endif %}
      | {{ current_user.full_name }} ({{ current_user.role }}) - <a href="/logout">Deconnexion</a>
    {% else %}
      <a href="/login">Connexion</a>
    {% endif %}
  </span>
</nav>

<main>
  <div class="card">
    <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px;">
      <h1>Tickets</h1>
      <a class="btn" href="/tickets/nouveau">+ Nouveau ticket</a>
    </div>

    <div class="mt-2">
      <form method="get">
        <div class="form-row">
          <div>
            <label for="client_id">Client</label>
            <select name="client_id" id="client_id">
              <option value="">Tous</option>
              {% for c in clients %}
              <option value="{{ c.id }}" {% if filters.client_id and filters.client_id == c.id %}selected{% endif %}>{{ c.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="client_nom">Nom client</label>
            <input type="text" name="client_nom" id="client_nom" placeholder="Rechercher un client" value="{{ filters.client_nom }}">
          </div>
          <div>
            <label for="materiel_type_id">Type materiel</label>
            <select name="materiel_type_id" id="materiel_type_id">
              <option value="">Tous</option>
              {% for mt in materiel_types %}
              <option value="{{ mt.id }}" {% if filters.materiel_type_id and filters.materiel_type_id == mt.id %}selected{% endif %}>{{ mt.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="materiel_search">Materiel (texte)</label>
            <input type="text" name="materiel_search" id="materiel_search" placeholder="Type, modele ou serie" value="{{ filters.materiel_search }}">
          </div>
        </div>

        <div class="form-row mt-1">
          <div>
            <label for="titre">Titre</label>
            <input type="text" name="titre" id="titre" value="{{ filters.titre }}" placeholder="Titre du ticket">
          </div>
          <div>
            <label for="type">Type</label>
            <select name="type" id="type">
              <option value="">Tous</option>
              <option value="incident" {% if filters.type == "incident" %}selected{% endif %}>Incident</option>
              <option value="demande" {% if filters.type == "demande" %}selected{% endif %}>Demande</option>
            </select>
          </div>
          <div>
            <label for="priorite">Priorite</label>
            <select name="priorite" id="priorite">
              <option value="">Toutes</option>
              <option value="basse" {% if filters.priorite == "basse" %}selected{% endif %}>Basse</option>
              <option value="normale" {% if filters.priorite == "normale" %}selected{% endif %}>Normale</option>
              <option value="haute" {% if filters.priorite == "haute" %}selected{% endif %}>Haute</option>
            </select>
          </div>
          <div>
            <label for="etat">Etat</label>
            <select name="etat" id="etat">
              <option value="">Tous</option>
              <option value="ouvert" {% if filters.etat == "ouvert" %}selected{% endif %}>Ouvert</option>
              <option value="en_cours" {% if filters.etat == "en_cours" %}selected{% endif %}>En cours</option>
              <option value="resolu" {% if filters.etat == "resolu" %}selected{% endif %}>Resolu</option>
              <option value="cloture" {% if filters.etat == "cloture" %}selected{% endif %}>Cloture</option>
            </select>
          </div>
        </div>

        <div class="form-row mt-1">
          <div>
            <label for="date_debut">Ouvert du</label>
            <input type="date" name="date_debut" id="date_debut" value="{{ filters.date_debut }}">
          </div>
          <div>
            <label for="date_fin">au</label>
            <input type="date" name="date_fin" id="date_fin" value="{{ filters.date_fin }}">
          </div>
          <div>
            <label for="sort">Trier par</label>
            <select name="sort" id="sort">
              <option value="date_desc" {% if sort == "date_desc" %}selected{% endif %}>Date ouverture (recents)</option>
              <option value="date_asc" {% if sort == "date_asc" %}selected{% endif %}>Date ouverture (anciens)</option>
              <option value="client" {% if sort == "client" %}selected{% endif %}>Client</option>
              <option value="titre" {% if sort == "titre" %}selected{% endif %}>Titre</option>
              <option value="type" {% if sort == "type" %}selected{% endif %}>Type</option>
              <option value="priorite" {% if sort == "priorite" %}selected{% endif %}>Priorite</option>
              <option value="etat" {% if sort == "etat" %}selected{% endif %}>Etat</option>
              <option value="materiel" {% if sort == "materiel" %}selected{% endif %}>Type materiel</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px;">
            <button type="submit">Filtrer / Trier</button>
            <a class="btn secondary" href="/tickets">Reinitialiser</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; margin-bottom:10px;">
      <div class="card" style="flex:1; min-width:280px; padding:12px;">
        <h3 style="margin-top:0;">Colonnes affichées</h3>
        <div class="form-actions" style="margin-bottom:8px;">
          <button type="button" class="btn" id="col-up">Monter</button>
          <button type="button" class="btn" id="col-down">Descendre</button>
        </div>
        <select id="col-select" multiple size="8" style="width:100%; min-height:180px;">
          <option value="id">ID</option>
          <option value="titre">Titre</option>
          <option value="client">Client</option>
          <option value="materiel">Materiel</option>
          <option value="type">Type</option>
          <option value="priorite">Priorite</option>
          <option value="assignee">Assigné à</option>
          <option value="categorie">Catégorie matérielle</option>
          <option value="type_materiel">Type matériel</option>
          <option value="etat">Etat</option>
          <option value="ouverture">Ouvert le</option>
          <option value="description">Description</option>
        </select>
      </div>
    </div>

    <table id="tickets-table">
      <thead>
        <tr id="tickets-head"></tr>
      </thead>
      <tbody id="tickets-body">
      {% for t in tickets %}
        <tr>
          <td data-col="id"><a href="/tickets/{{ t.id }}">{{ t.id }}</a></td>
          <td data-col="titre">{{ t.titre }}</td>
          <td data-col="client">CLT-{{ "%04d"|format(t.client.id) }} - {{ t.client.nom }}</td>
          <td data-col="materiel">
            {% if t.materiels %}
              {% for m in t.materiels %}
                {{ m.type }} {{ m.modele }} ({{ m.numero_serie }}){% if not loop.last %}, {% endif %}
              {% endfor %}
            {% else %}
              -
            {% endif %}
          </td>
          <td data-col="type">{{ t.type }}</td>
          <td data-col="priorite">{{ t.priorite }}</td>
          <td data-col="assignee">
            {% if t.assigned_group %}
              Groupe {{ t.assigned_group.name }}
            {% elif t.assigned_user %}
              {{ t.assigned_user.full_name }}
            {% else %}
              Non assigné
            {% endif %}
          </td>
          <td data-col="categorie">{{ t.category.name if t.category else "-" }}</td>
          <td data-col="type_materiel">{{ t.materiel_type.name if t.materiel_type else "-" }}</td>
          <td data-col="etat">{{ t.etat }}</td>
          <td data-col="ouverture">{{ t.date_ouverture.strftime("%d/%m/%Y %H:%M") }}</td>
          <td data-col="description">{{ t.description or "-" }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</main>

<script>
  const availableCols = {
    id: "ID",
    titre: "Titre",
    client: "Client",
    materiel: "Materiel",
    type: "Type",
    priorite: "Priorite",
    assignee: "Assigné à",
    categorie: "Catégorie matérielle",
    type_materiel: "Type matériel",
    etat: "Etat",
    ouverture: "Ouvert le",
    description: "Description",
  };

  const defaultOrder = ["id","titre","client","materiel","type","priorite","assignee","categorie","type_materiel","etat","ouverture"];
  const storageKey = "tickets_columns_order_v1";

  function loadOrder() {
    const stored = localStorage.getItem(storageKey);
    if (!stored) return [...defaultOrder];
    try {
      const arr = JSON.parse(stored);
      return Array.isArray(arr) && arr.length ? arr.filter(c => availableCols[c]) : [...defaultOrder];
    } catch (_) {
      return [...defaultOrder];
    }
  }

  function saveOrder(order) {
    localStorage.setItem(storageKey, JSON.stringify(order));
  }

  function applyOrder(order) {
    const head = document.getElementById("tickets-head");
    const bodyRows = document.querySelectorAll("#tickets-body tr");
    head.innerHTML = "";
    order.forEach(col => {
      const th = document.createElement("th");
      th.textContent = availableCols[col] || col;
      head.appendChild(th);
    });
    bodyRows.forEach(row => {
      const cells = {};
      row.querySelectorAll("td").forEach(td => { cells[td.dataset.col] = td; });
      row.innerHTML = "";
      order.forEach(col => {
        const cell = cells[col];
        if (cell) {
          cell.style.display = "";
          row.appendChild(cell);
        }
      });
    });
  }

  function syncSelect(order) {
    const select = document.getElementById("col-select");
    select.innerHTML = "";
    Object.entries(availableCols).forEach(([key,label]) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = label;
      select.appendChild(opt);
    });
    order.forEach(col => {
      const opt = select.querySelector(`option[value="${col}"]`);
      if (opt) opt.selected = true;
    });
  }

  function moveSelection(direction) {
    const select = document.getElementById("col-select");
    const order = Array.from(select.options).filter(o => o.selected).map(o => o.value);
    let current = loadOrder();
    order.forEach(col => {
      const idx = current.indexOf(col);
      if (idx === -1) return;
      const swapWith = direction === "up" ? idx - 1 : idx + 1;
      if (swapWith < 0 || swapWith >= current.length) return;
      [current[idx], current[swapWith]] = [current[swapWith], current[idx]];
    });
    saveOrder(current);
    syncSelect(current);
    applyOrder(current);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const order = loadOrder();
    syncSelect(order);
    applyOrder(order);

    document.getElementById("col-up").addEventListener("click", () => moveSelection("up"));
    document.getElementById("col-down").addEventListener("click", () => moveSelection("down"));

    const select = document.getElementById("col-select");
    select.addEventListener("change", () => {
      // Keep order of existing, just toggle visibility by removal/addition
      let current = loadOrder();
      const selected = Array.from(select.selectedOptions).map(o => o.value);
      // Ensure selected columns keep their relative order; remove unselected
      current = current.filter(c => selected.includes(c));
      // Add newly selected that were not in current at the end in available order
      Object.keys(availableCols).forEach(col => {
        if (selected.includes(col) && !current.includes(col)) current.push(col);
      });
      saveOrder(current);
      applyOrder(current);
    });
  });
</script>

</body>
</html>
